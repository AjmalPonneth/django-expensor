{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block body %}

<div class="row">
<div class="ui-widget col-sm-12 col-md-6 col-lg-6">
  <form method="post" id="id_add_expense" action="">
    {% csrf_token %}
    {{ form|crispy }}
    <input type="submit" class="btn btn-primary" value="{{ title }}">
  </form>
</div>
</div>

<br>
<div class="row">
<div class="col-sm-12 col-md-6 col-lg-6">
  <p id="id_success" class="alert alert-success" style="display:none;"></p>
  <p id="id_error" class="alert alert-danger" style="display:none;"></p>
</div>
</div>

{% if objects %}

<div class="col-sm-12 col-md-6 col-lg-6">

  <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <!-- Basic Stat Accordion -->
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
          <h4 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#basicStatCollapsible" aria-expanded="false" aria-controls="basicStatCollapsible">
              Basic Information
            </a>
          </h4>
        </div>
        <div id="basicStatCollapsible" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            
            <div id="basicInfoContent">
            </div>

          </div>
        </div>
      </div>

      <!-- Recent  -->
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingTwo">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#recentTxn" aria-expanded="false" aria-controls="recentTxn">
              Recent Transactions
            </a>
          </h4>
        </div>
        <div id="recentTxn" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            {% include 'expense_table.html' %}
            <center><a href="{% url 'expense:expense_list' %}">See All</a></center>
          </div>
        </div>
      </div>

  </div>

</div>

{% endif %}


{% endblock %}


{% block js %}
<script type="text/javascript">

  $(document).ready(function(){

    $("#id_remark").autocomplete({
      source: "{% url 'expense:get_remark' %}",
    });

    $("#id_timestamp").datepicker();

    //$('#basicStatCollapsible').on('show.bs.collapse', function () {
    //  fetchBasicInfo();
    //});

    var form = $("#id_add_expense");

    form.submit(function(){
      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: form.serialize(),
        success: function(data){
          $("#id_error").css("display", "none");
          form[0].reset();
          $("#id_success").text("Added successfully.");
          $("#id_success").css("display", "inline-block");

          setTimeout(function() {
            $("#id_success").hide();
          }, 5000);
        },
        error: function(data){
          $("#id_success").css("display", "none");
          $("#id_error").text("Some error has occured. Failed to save.");
          $("#id_error").css("display", "inline-block");
        }
      });
      return false;
    });
  });

  function fetchBasicInfo() {
    basicInfoContent = $("#basicInfoContent")
    basicInfoContent.html('');

    $.ajax({
      type: "GET",
      url: '{% url "expense:get-basic-info" %}',
      success: function(data){
        basicInfoContent.append("<h5>Spent Today: "+ data.today_expense +"</h5>");
        basicInfoContent.append("<h5>Spent this month: "+ data.this_month_expense +"</h5>");
        basicInfoContent.append('<h5>EIR: '+ data.expense_to_income_ratio +'%</h5>');
      },
      error: function(data){
        console.log(data);
        console.log('error while fetching basic info data');
      }
    });
  }
  
  $( window ).on( "load", function() {
    fetchBasicInfo();
  });

</script>
{% endblock js %}
