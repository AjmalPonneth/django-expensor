{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}


{% block body %}

<div class="row">
  <div class="ui-widget col-sm-12 col-md-6 col-lg-6">

    <form method="post" id="id_add_expense" action="">
      {% csrf_token %}
      {{ form|crispy }}
      <input type="submit" class="btn btn-primary btn-block" value="{{ title }}">
    </form>

    <br>
    <div id="id_success" class="alert alert-success" role="alert" style="display:none;">Expense added successfully.</div>
    <div id="id_error" class="alert alert-danger" role="alert" style="display:none;">Some error has occured. Failed to save.</div>

  </div>
</div>



<div class="col-sm-12 col-md-6 col-lg-6">

  <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <!-- Basic Stat Accordion -->
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
          <h4 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#basicInfoCollapsible" aria-expanded="false" aria-controls="basicInfoCollapsible">
              <div>Stats</div>
            </a>
          </h4>
        </div>
        <div id="basicInfoCollapsible" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            
            <div id="basicInfoContent">
              <div class="rows">

                <div class="col-lg-6 col-md-6">
                  <h5>Spent today: <span id="today_expense"></span> <a href="{% url 'expense:day-wise-expense' %}"><i class="fas fa-external-link-square-alt"></i></a></h5>
                  <h5>Spent this month: <span id="month_expense"></span> <a href="{% url 'expense:month-wise-expense' %}"><i class="fas fa-external-link-square-alt"></i></a></h5>
                </div>

                <div class="col-sm-1"></div>
                
                <div class="col-lg-6 col-md-6">
                  <h5><span data-toggle="tooltip" data-placement="top" title="Expense to Income Ratio (All Time)">EIR: <span id="eir"></span></span></h5>
                  <h5><span data-toggle="tooltip" data-placement="top" title="Expense to Income Ratio (Only for Current Month)">This month's EIR: <span id="month_eir"></span></span></h5>
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Recent  -->
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingTwo">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#recentTxn" aria-expanded="false" aria-controls="recentTxn">
              <div>Recent Expenses</div>
            </a>
          </h4>
        </div>
        <div id="recentTxn" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            <table class="table table-striped" id="txn-list"></table>

            <center><a href="{% url 'expense:expense_list' %}">See All</a></center>
          </div>
        </div>
      </div>

  </div>

</div>


{% endblock %}


{% block js %}
<script type="text/javascript">
  spinner = '<i class="fas fa-spinner fa-sm"></i>'

  function fetchBasicInfo() {
    $("#today_expense").html(spinner);
    $("#month_expense").html(spinner);
    $("#eir").html(spinner);
    $("#month_eir").html(spinner);

    $.ajax({
      type: "GET",
      url: '{% url "expense:get-basic-info" %}',
      success: function(data){
        $("#today_expense").html(data.today_expense);
        $("#month_expense").html(data.this_month_expense);
        $("#eir").html(data.expense_to_income_ratio + "%");
        $("#month_eir").html(data.this_month_eir + "%");
      },
      error: function(data){
        console.log(data);
        console.log('error while fetching basic info data');
      }
    });
  }

  function fetchLatestExpenses() {
    rows = $("#txn-list")
    header = "<thead><tr><th>Date</th><th>Amount</th><th>Remark</th><th>Action</th></tr></thead>"
    spinner_row = "<tr><td>"+ spinner +"</td><td>"+ spinner +"</td><td>"+ spinner +"</td><td>"+ spinner +"</td></tr>"
    rows.empty();
    rows.append(header);
    rows.append(spinner_row);

    $.ajax({
      type: "GET",
      url: '{% url "expense:get-latest-expenses" %}',
      success: function(data){
        row = header
        for (i=0; i < data.length; i++) {
          row += "<tr>"
          row += "<td>"+ data[i].timestamp +"</td>"
          row += "<td>"+ data[i].amount +"</td>"
          row += "<td>"+ data[i].remark +"</td>"
          row += '<td><a href="/update/'+ data[i].id +'/">Edit</a></td>'
          row += "</tr>"
        }
        rows.empty();
        rows.append(row);
      },
      error: function(data){
        console.log(data);
        console.log('error while fetching basic info data');
      }
    });
  }

  $(document).ready(function(){

    $("#id_remark").autocomplete({
      source: "{% url 'expense:get_remark' %}"
    });

    $("#id_timestamp").datepicker();

    $("#id_amount").keyup(function() {
      $("#hint_id_amount").html( inWords($('#id_amount').val()) )
    });

    $('#basicInfoCollapsible').on('show.bs.collapse', function () {
      fetchBasicInfo();
    });

    $('#recentTxn').on('show.bs.collapse', function () {
      fetchLatestExpenses();
    });

    var form = $("#id_add_expense");

    form.submit(function(){
      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: form.serialize(),
        success: function(data) {
          $("#hint_id_amount").html("");
          form[0].reset();

          $("#id_error").hide();
          $("#id_success").show();

          setTimeout(function() {
            $("#id_success").hide();
          }, 5000);

          // updating accordion if new expense is added and accordion is open
          if ( $("#basicInfoCollapsible.in").length == 1 ) {
            fetchBasicInfo();
          }
          if ( $("#recentTxn.in").length == 1 ) {
            fetchLatestExpenses();
          }

        },
        error: function(data) {
          $("#id_success").hide();
          $("#id_error").show();
        }
      });
      return false;
    });
    
  });

</script>
{% endblock js %}
